<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å - –†–µ—Å—Ç–æ—Ä–∞–Ω –£—Å–∞–¥—å–±–∞</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    
    <header class="header">
        <button class="back-button" onclick="goBack()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
            –ù–∞–∑–∞–¥
        </button>
        <div class="header-left" style="gap: 12px;">
            <div class="logo">
                <img src="./icons/logo.png" alt="Logo" width="20" height="20">
            </div>
            <div class="header-title">
                <h1>–†–µ—Å—Ç–æ—Ä–∞–Ω –£—Å–∞–¥—å–±–∞</h1>
                <p>POS-—Å–∏—Å—Ç–µ–º–∞</p>
            </div>
        </div>
        <div style="width: 80px;"></div>
    </header>

    
    <div class="container">
        
        <div class="card profile-card">
            <div class="profile-row">
                <div class="profile-left">
                    <div class="avatar-wrapper">
                        <div class="avatar" id="avatarInitials">–ò–ò</div>
                        <button class="avatar-upload-btn" onclick="document.getElementById('avatarInput').click()" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                <circle cx="12" cy="13" r="4"></circle>
                            </svg>
                        </button>
                        <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
                    </div>
                    <div>
                        <div class="profile-name-row">
                            <h2 id="userName">–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤</h2>
                            <span class="badge" id="userRoleBadge">–û—Ñ–∏—Ü–∏–∞–Ω—Ç</span>
                        </div>
                        <div class="profile-meta-row">
                            <div class="meta-item">
                                <span class="dot"></span>
                                <span id="userEmail">ivan.ivanov@usadba.ru</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <svg class="stat-icon" style="stroke: #ea580c;" viewBox="0 0 24 24">
                        <line x1="16.5" y1="9.4" x2="7.5" y2="4.21"></line>
                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
                        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
                        <line x1="12" y1="22.08" x2="12" y2="12"></line>
                    </svg>
                    <span class="stat-change">+12%</span>
                </div>
                <p class="stat-label">–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞–∫–∞–∑–æ–≤</p>
                <p class="stat-value">248</p>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <svg class="stat-icon" style="stroke: #f43f5e;" viewBox="0 0 24 24">
                        <line x1="12" y1="1" x2="12" y2="23"></line>
                        <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                    </svg>
                    <span class="stat-change">+8%</span>
                </div>
                <p class="stat-label">–û–±—â–∞—è —Å—É–º–º–∞</p>
                <p class="stat-value">‚ÇΩ 458,320</p>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <svg class="stat-icon" style="stroke: #f59e0b;" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    <span class="stat-change">+5%</span>
                </div>
                <p class="stat-label">–†–∞–±–æ—á–∏—Ö —á–∞—Å–æ–≤</p>
                <p class="stat-value">156</p>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <svg class="stat-icon" style="stroke: #f97316;" viewBox="0 0 24 24">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                    </svg>
                    <span class="stat-change">+3%</span>
                </div>
                <p class="stat-label">–°—Ä–µ–¥–Ω–∏–π —á–µ–∫</p>
                <p class="stat-value">‚ÇΩ 1,847</p>
            </div>
        </div>

        
        <div class="orders-section" style="margin-top: 32px;">
            <h2 class="section-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h2>
            
            
            <div class="orders-tabs">
                <button class="orders-tab active" data-tab="pending" onclick="switchOrdersTab('pending')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    –û–∂–∏–¥–∞—é—Ç –æ–ø–ª–∞—Ç—ã
                    <span class="tab-badge" id="pendingOrdersCount">0</span>
                </button>
                <button class="orders-tab" data-tab="paid" onclick="switchOrdersTab('paid')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    –û–ø–ª–∞—á–µ–Ω–æ
                    <span class="tab-badge" id="paidOrdersCount">0</span>
                </button>
            </div>

            
            <div class="orders-tab-content active" id="pendingOrdersContent">
                <div class="active-orders-grid" id="activeOrdersGrid">
                    
                </div>
            </div>

            
            <div class="orders-tab-content" id="paidOrdersContent">
                <div class="active-orders-grid" id="paidOrdersGrid">
                    
                </div>
            </div>
        </div>
    </div>
    <script src="js/validation.js"></script>
    <script src="js/database.js"></script>
    <script src="js/script.js"></script>
    <script>
        let currentUserId = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
        async function uploadAvatar(input) {
            const file = input.files[0];
            if (!file) return;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–∞ (–º–∞–∫—Å 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 5MB');
                return;
            }

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
            if (!file.type.startsWith('image/')) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ');
                return;
            }

            try {
                // –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    const base64Image = e.target.result;
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                    if (!window.db || !window.db.db) {
                        alert('–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
                        return;
                    }

                    if (!currentUserId) {
                        alert('–û—à–∏–±–∫–∞: ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω');
                        return;
                    }

                    const user = window.db.findById('users', currentUserId);
                    if (!user) {
                        alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }

                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    user.avatar = base64Image;
                    const updated = window.db.update('users', currentUserId, user);
                    
                    if (updated) {
                        console.log('‚úÖ –ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω');
                        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        updateAvatarDisplay(base64Image);
                    } else {
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä');
                    }
                };
                reader.readAsDataURL(file);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∞
        function updateAvatarDisplay(avatarUrl) {
            const avatarElement = document.getElementById('avatarInitials');
            if (avatarElement && avatarUrl) {
                avatarElement.style.backgroundImage = `url(${avatarUrl})`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.textContent = ''; // –£–±–∏—Ä–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª—ã/–∏–∫–æ–Ω–∫–∏
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–æ–≤
        function getInitials(name) {
            if (!name) return '??';
            const parts = name.trim().split(' ');
            if (parts.length >= 2) {
                return (parts[0][0] + parts[1][0]).toUpperCase();
            }
            return name.substring(0, 2).toUpperCase();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        async function initProfile() {
            // –ñ–¥–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î
            if (!window.dbInitialized) {
                await window.initializeDatabase();
            }

            // –ü–æ–ª—É—á–∞–µ–º userId –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            currentUserId = parseInt(urlParams.get('userId'));

            if (!currentUserId) {
                alert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
                return;
            }

            const user = window.db.findById('users', currentUserId);
            if (!user) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                return;
            }

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–æ–ª—å
            const role = window.db.findById('roles', user.role_id);

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('userName').textContent = user.name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            document.getElementById('userEmail').textContent = user.email || '–ù–µ —É–∫–∞–∑–∞–Ω';
            document.getElementById('userRoleBadge').textContent = role ? role.name : '–†–æ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞';

            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–≤–∞—Ç–∞—Ä
            const avatarElement = document.getElementById('avatarInitials');
            if (user.avatar) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
                avatarElement.style.backgroundImage = `url(${user.avatar})`;
                avatarElement.textContent = '';
            } else if (user.role_id === 2) {
                // –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É admin
                avatarElement.style.backgroundImage = `url('./icons/admin.png')`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.textContent = '';
            } else if (user.role_id === 3) {
                // –ü–æ–≤–∞—Ä - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–∫–æ–Ω–∫—É chef
                avatarElement.style.backgroundImage = `url('./icons/chef.png')`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.textContent = '';
            } else {
                // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–æ–ª–∏ - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º logo
                avatarElement.style.backgroundImage = `url('./icons/logo.png')`;
                avatarElement.style.backgroundSize = 'cover';
                avatarElement.textContent = '';
            }

            console.log('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω:', user);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥
        function goBack() {
            if (!currentUserId) {
                window.location.href = 'main.html';
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
            const user = window.db.findById('users', currentUserId);
            if (user) {
                const userRole = window.db.findById('roles', user.role_id);
                const roleCode = userRole ? userRole.code : 'waiter';
                
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å –ø–æ–ª–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                const params = new URLSearchParams({
                    userId: user.id,
                    name: user.name,
                    email: user.email,
                    role: roleCode
                });
                window.location.href = `main.html?${params.toString()}`;
            } else {
                window.location.href = 'main.html';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫
        window.switchOrdersTab = function(tab) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.querySelectorAll('.orders-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.orders-tab[data-tab="${tab}"]`).classList.add('active');

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç
            document.querySelectorAll('.orders-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tab}OrdersContent`).classList.add('active');
        };

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        function loadActiveOrders() {
            if (!currentUserId || !window.db || !window.db.db) {
                return;
            }

            const activeOrdersGrid = document.getElementById('activeOrdersGrid');
            const pendingCountBadge = document.getElementById('pendingOrdersCount');
            
            if (!activeOrdersGrid) return;

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏ —Å—á–µ—Ç–∞–º–∏
            const allOrders = window.db.getAll('orders');
            const allBills = window.db.getAll('bills');
            
            // –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –µ—â–µ –Ω–µ –æ–ø–ª–∞—á–µ–Ω—ã
            const activeOrders = allOrders.filter(order => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                if (order.user_id !== currentUserId) return false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∑–∞–∫–∞–∑–∞ –µ—Å—Ç—å —Å—á–µ—Ç –∏ –æ–Ω –Ω–µ –æ–ø–ª–∞—á–µ–Ω
                const orderBill = allBills.find(bill => bill.order_id === order.id);
                return !orderBill || orderBill.status_id === 1; // 1 = –ù–ï_–û–ü–õ–ê–ß–ï–ù
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (pendingCountBadge) {
                pendingCountBadge.textContent = activeOrders.length;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
            if (activeOrders.length === 0) {
                activeOrdersGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.3;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                        <p>–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                    </div>
                `;
                return;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º –∑–∞–∫–∞–∑—ã
            activeOrdersGrid.innerHTML = activeOrders.map(order => {
                const table = window.db.findById('tables', order.table_id);
                const status = window.db.findById('order_status', order.status_id);
                const items = window.db.getOrderItems(order.id);
                const total = window.db.calculateOrderTotal(order.id);

                return `
                    <div class="active-order-card">
                        <div class="active-order-header">
                            <div class="active-order-info">
                                <div class="active-order-number">–ó–∞–∫–∞–∑ #${order.id}</div>
                                <div class="active-order-table">–°—Ç–æ–ª ${table ? table.number : '?'}</div>
                            </div>
                            <span class="active-order-status">${status ? status.name : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                        </div>
                        <div class="active-order-items">
                            ${items.map(item => {
                                const dish = window.db.findById('dishes', item.dish_id);
                                return `
                                    <div class="active-order-item">
                                        <span class="active-order-item-name">${dish ? dish.name : '–ë–ª—é–¥–æ'}</span>
                                        <span class="active-order-item-qty">x${item.count}</span>
                                        <span class="active-order-item-price">${window.formatMoney(item.price * item.count)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="active-order-footer">
                            <div class="active-order-total">${window.formatMoney(total)}</div>
                            <button class="active-order-pay-btn" onclick="payActiveOrder(${order.id}, ${total})">–û–ø–ª–∞—Ç–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            }).join('');

            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${activeOrders.length} –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        function loadPaidOrders() {
            if (!currentUserId || !window.db || !window.db.db) {
                return;
            }

            const paidOrdersGrid = document.getElementById('paidOrdersGrid');
            const paidCountBadge = document.getElementById('paidOrdersCount');
            
            if (!paidOrdersGrid) return;

            // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞–∫–∞–∑—ã —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º–∏ —Å—á–µ—Ç–∞–º–∏
            const allOrders = window.db.getAll('orders');
            const allBills = window.db.getAll('bills');
            
            // –ù–∞—Ö–æ–¥–∏–º –∑–∞–∫–∞–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–ø–ª–∞—á–µ–Ω—ã
            const paidOrders = allOrders.filter(order => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∑–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
                if (order.user_id !== currentUserId) return false;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —É –∑–∞–∫–∞–∑–∞ –µ—Å—Ç—å —Å—á–µ—Ç –∏ –æ–Ω –æ–ø–ª–∞—á–µ–Ω
                const orderBill = allBills.find(bill => bill.order_id === order.id);
                return orderBill && orderBill.status_id === 2; // 2 = –û–ü–õ–ê–ß–ï–ù
            }).sort((a, b) => b.id - a.id); // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é ID (–Ω–æ–≤—ã–µ —Å–Ω–∞—á–∞–ª–∞)

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            if (paidCountBadge) {
                paidCountBadge.textContent = paidOrders.length;
            }

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é
            if (paidOrders.length === 0) {
                paidOrdersGrid.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #6b7280;">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin: 0 auto 16px; opacity: 0.3;">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                        <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</p>
                    </div>
                `;
                return;
            }

            // –†–µ–Ω–¥–µ—Ä–∏–º –∑–∞–∫–∞–∑—ã
            paidOrdersGrid.innerHTML = paidOrders.map(order => {
                const table = window.db.findById('tables', order.table_id);
                const status = window.db.findById('order_status', order.status_id);
                const items = window.db.getOrderItems(order.id);
                const total = window.db.calculateOrderTotal(order.id);
                const bill = allBills.find(b => b.order_id === order.id);
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
                const orderDate = order.created_at ? new Date(order.created_at).toLocaleString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : '–î–∞—Ç–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–∞';

                return `
                    <div class="active-order-card paid-order-card">
                        <div class="active-order-header">
                            <div class="active-order-info">
                                <div class="active-order-number">–ó–∞–∫–∞–∑ #${order.id}</div>
                                <div class="active-order-table">–°—Ç–æ–ª ${table ? table.number : '?'} ‚Ä¢ ${orderDate}</div>
                            </div>
                            <span class="active-order-status paid-status">‚úì –û–ø–ª–∞—á–µ–Ω–æ</span>
                        </div>
                        <div class="active-order-items">
                            ${items.map(item => {
                                const dish = window.db.findById('dishes', item.dish_id);
                                return `
                                    <div class="active-order-item">
                                        <span class="active-order-item-name">${dish ? dish.name : '–ë–ª—é–¥–æ'}</span>
                                        <span class="active-order-item-qty">x${item.count}</span>
                                        <span class="active-order-item-price">${window.formatMoney(item.price * item.count)}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div class="active-order-footer">
                            <div class="active-order-total">${window.formatMoney(total)}</div>
                            <div class="paid-order-method">
                                ${bill && bill.payment_method ? getPaymentMethodIcon(bill.payment_method) : 'üí≥'}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${paidOrders.length} –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤`);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        function getPaymentMethodIcon(method) {
            const icons = {
                'cash': 'üíµ –ù–∞–ª–∏—á–Ω—ã–µ',
                'card': 'üí≥ –ö–∞—Ä—Ç–∞',
                'online': 'üåê –û–Ω–ª–∞–π–Ω'
            };
            return icons[method] || 'üí≥ –ö–∞—Ä—Ç–∞';
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–ø–ª–∞—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
        window.payActiveOrder = function(orderId, total) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–ø–ª–∞—Ç—ã
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('userId');
            
            if (!userId) {
                showAlert('–û—à–∏–±–∫–∞: –Ω–µ —É–∫–∞–∑–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å');
                return;
            }

            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –≥–ª–∞–≤–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º –¥–ª—è –æ–ø–ª–∞—Ç—ã –∑–∞–∫–∞–∑–∞
            const user = window.db.findById('users', currentUserId);
            if (user) {
                const userRole = window.db.findById('roles', user.role_id);
                const roleCode = userRole ? userRole.code : 'waiter';
                
                const params = new URLSearchParams({
                    userId: user.id,
                    name: user.name,
                    email: user.email,
                    role: roleCode,
                    payOrderId: orderId
                });
                window.location.href = `main.html?${params.toString()}`;
            }
        };

        // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –∏ –∑–∞–∫–∞–∑—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            await initProfile();
            loadActiveOrders();
            loadPaidOrders();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ë–î
            window.addEventListener('databaseUpdated', () => {
                loadActiveOrders();
                loadPaidOrders();
            });
        });
    </script>
</body>
</html>